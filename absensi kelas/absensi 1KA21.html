<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Digital - Kelas 1KA21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Backup CDN jika yang utama gagal -->
    <script>
        // Check if libraries loaded, if not load backup
        window.addEventListener('load', function() {
            if (!window.jspdf) {
                const script1 = document.createElement('script');
                script1.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
                document.head.appendChild(script1);
                
                script1.onload = function() {
                    const script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js';
                    document.head.appendChild(script2);
                };
            }
            
            if (!window.XLSX) {
                const script3 = document.createElement('script');
                script3.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
                document.head.appendChild(script3);
            }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .attendance-btn {
            transition: all 0.3s ease;
        }
        
        .attendance-btn:hover {
            transform: scale(1.05);
        }
        
        .student-card {
            transition: all 0.2s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Halaman Utama -->
    <div id="mainPage" class="container mx-auto px-4 py-8">
        <!-- Header Identitas Sekolah -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8 text-center card-hover">
            <div class="flex items-center justify-center mb-6">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-full">
                    <i class="fas fa-graduation-cap text-white text-4xl"></i>
                </div>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">UNIVERSITAS GUNADARMA</h1>
            <h2 class="text-2xl font-semibold text-blue-600 mb-2">FAKULTAS SISTEM INFORMASI</h2>
            <h3 class="text-xl font-medium text-gray-600 mb-4">PROGRAM STUDI S1</h3>
            <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-full inline-block">
                <span class="text-lg font-semibold">KELAS 1KA21-SISTEM INFORMASI</span>
            </div>
        </div>

        <!-- Tanggal dan Kontrol -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8 card-hover">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                        <span id="currentDate"></span>
                    </h3>
                    <p class="text-gray-600">Sistem Absensi Digital</p>
                </div>
                
                <div class="flex gap-4">
                    <button id="absenMasuk" class="attendance-btn bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl">
                        <i class="fas fa-sign-in-alt mr-2"></i>Absen Masuk
                    </button>
                </div>
            </div>
        </div>

        <!-- Tombol Hadir Semua -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8 card-hover">
            <div class="flex justify-between items-center">
                <div>
                    <h4 class="text-xl font-bold text-gray-800 mb-2">Kontrol Cepat</h4>
                    <p class="text-gray-600">Tandai semua siswa hadir dengan satu klik</p>
                </div>
                <button id="hadirSemua" class="attendance-btn bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl">
                    <i class="fas fa-users mr-2"></i>Hadir Semua
                </button>
            </div>
        </div>

        <!-- Daftar Siswa -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    Daftar Kehadiran Siswa
                </h3>
                <button id="viewRecap" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl attendance-btn">
                    <i class="fas fa-chart-bar mr-2"></i>Lihat Rekap
                </button>
            </div>
            
            <div id="studentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Siswa akan dimuat di sini -->
            </div>
        </div>
    </div>

    <!-- Halaman Rekap -->
    <div id="recapPage" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-chart-line text-purple-500 mr-2"></i>
                    Rekap Kehadiran
                </h2>
                <div class="flex gap-4">
                    <button id="exportPDF" class="no-print bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl attendance-btn">
                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                    </button>
                    <button id="exportExcel" class="no-print bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl attendance-btn">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                    <button id="printRecap" class="no-print bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl attendance-btn">
                        <i class="fas fa-print mr-2"></i>Cetak
                    </button>
                    <button id="backToMain" class="no-print bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl attendance-btn">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="no-print flex mb-6 bg-gray-100 rounded-xl p-1">
                <button id="dailyTab" class="flex-1 py-3 px-6 rounded-lg font-semibold transition-all duration-300 bg-blue-500 text-white">
                    <i class="fas fa-calendar-day mr-2"></i>Rekap Harian
                </button>
                <button id="monthlyTab" class="flex-1 py-3 px-6 rounded-lg font-semibold transition-all duration-300 text-gray-600 hover:text-blue-500">
                    <i class="fas fa-calendar-alt mr-2"></i>Rekap Bulanan
                </button>
            </div>

            <!-- Daily Recap -->
            <div id="dailyRecap">
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rekap Kehadiran Hari Ini</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-xl text-center">
                            <i class="fas fa-user-check text-green-500 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold text-green-600" id="totalHadir">0</p>
                            <p class="text-green-600 font-medium">Hadir</p>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-xl text-center">
                            <i class="fas fa-user-clock text-yellow-500 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold text-yellow-600" id="totalIzin">0</p>
                            <p class="text-yellow-600 font-medium">Izin</p>
                        </div>
                        <div class="bg-red-100 p-4 rounded-xl text-center">
                            <i class="fas fa-user-times text-red-500 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold text-red-600" id="totalSakit">0</p>
                            <p class="text-red-600 font-medium">Sakit</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-xl text-center">
                            <i class="fas fa-users text-gray-500 text-2xl mb-2"></i>
                            <p class="text-2xl font-bold text-gray-600" id="totalSiswa">41</p>
                            <p class="text-gray-600 font-medium">Total Siswa</p>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">No</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Nama</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">NPM</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Status</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Waktu Masuk</th>
                            </tr>
                        </thead>
                        <tbody id="dailyTableBody">
                            <!-- Data akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Recap -->
            <div id="monthlyRecap" class="hidden">
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rekap Kehadiran Bulanan</h3>
                    <div class="mb-4">
                        <select id="monthSelect" class="no-print px-4 py-2 border border-gray-300 rounded-lg font-medium">
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">No</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Nama</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold">NPM</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Hadir</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Izin</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Sakit</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Persentase</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTableBody">
                            <!-- Data akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data siswa
        const students = [
            { name: "ABHINAYA AGHNI FADHILA", npm: "10124004" },
            { name: "ADITYA SAPUTRA", npm: "10124035" },
            { name: "ALI SALIM", npm: "10124105" },
            { name: "AMELIA D", npm: "10124130" },
            { name: "ARDIANTO TRI WICAKSONO", npm: "10124181" },
            { name: "CINDY FEBRIANTY", npm: "10124283" },
            { name: "DANANG FATURRIZKI", npm: "10124297" },
            { name: "DANIEL RIVALDI HARIANJA", npm: "10124305" },
            { name: "DIMAS FARREL REIVANO", npm: "910124352" },
            { name: "FAJAR PUTRA ANDRIAN", npm: "10124429" },
            { name: "FATHMA ATHIFAH", npm: "10124464" },
            { name: "FRANS STEVEN PAKPAHAN", npm: "11124484" },
            { name: "GHALI RADIFAN", npm: "10124520" },
            { name: "HASBIALLAH ALFARIZI", npm: "10124559" },
            { name: "IRENE SYAHWA DWINOV", npm: "10124599" },
            { name: "IRFAN ARIF", npm: "10124601" },
            { name: "KEVIN JOSHUA MARANATHA", npm: "10124649" },
            { name: "LINTANG MUTIA ASARI", npm: "10124676" },
            { name: "LUDY SETIAWAN NOER SYAWAL", npm: "10124680" },
            { name: "MICKY ANDHIKA MUCHTAR", npm: "10124731" },
            { name: "MUHAMMAD FAHMI", npm: "10124833" },
            { name: "MUHAMMAD FEBRIAN SYAHLAN", npm: "10124864" },
            { name: "MUHAMMAD IQBAL ALATIEF", npm: "10124887" },
            { name: "MUHAMMAD ITISHAM ARRASYID", npm: "10124892" },
            { name: "MUHAMMAD RIZKY PAUZAN", npm: "10124969" },
            { name: "MUHAMMAD ZAIDAN RIZQIRAMDANI", npm: "10124989" },
            { name: "MUHHAMAD RICKY YUSUF", npm: "10124996" },
            { name: "NABILA SYAFIRA", npm: "11124015" },
            { name: "NAILA NOOR SAFITRI", npm: "11124025" },
            { name: "NAJWIN ARIF SIDDIQ", npm: "11124032" },
            { name: "NATALIA", npm: "11124456" },
            { name: "RADEN MOCHAMAD BAGOES HARYO WI", npm: "11124095" },
            { name: "REIDO SURYO YUDHANANDA", npm: "11124196" },
            { name: "RIZKIYAH AFIATI", npm: "11124243" },
            { name: "SARAH FERRYANTI ANGGRAINI", npm: "11124284" },
            { name: "SINTIA MEILANI FADILLAH", npm: "11124308" },
            { name: "THERESIA SANDRA ZAO", npm: "11124338" },
            { name: "VITO DWI PRAEMSTYA", npm: "11124362" },
            { name: "ZAHRAH SYIFA ZAIN", npm: "11124407" },
            { name: "ZAKY ARKAN ZIDAN", npm: "11124413" },
            { name: "GABRIELLA ELIZABETH FERDINANDUS", npm: "19123009" }
        ];

        // State management
        let currentAttendanceType = 'masuk';
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let monthlyData = JSON.parse(localStorage.getItem('monthlyData')) || {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            renderStudentGrid();
            setupEventListeners();
            updateRecapStats();
        });

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        function renderStudentGrid() {
            const grid = document.getElementById('studentGrid');
            const today = new Date().toDateString();
            
            grid.innerHTML = students.map((student, index) => {
                const studentKey = `${student.npm}_${today}`;
                const attendance = attendanceData[studentKey] || { status: '', timeIn: '', timeOut: '' };
                
                return `
                    <div class="student-card bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center mb-3">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold mr-3">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-sm">${student.name}</h4>
                                <p class="text-gray-600 text-xs">${student.npm}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="setAttendance('${student.npm}', 'hadir')" 
                                    class="flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all duration-200 ${attendance.status === 'hadir' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-600 hover:bg-green-200'}">
                                <i class="fas fa-check mr-1"></i>Hadir
                            </button>
                            <button onclick="setAttendance('${student.npm}', 'izin')" 
                                    class="flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all duration-200 ${attendance.status === 'izin' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-600 hover:bg-yellow-200'}">
                                <i class="fas fa-clock mr-1"></i>Izin
                            </button>
                            <button onclick="setAttendance('${student.npm}', 'sakit')" 
                                    class="flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all duration-200 ${attendance.status === 'sakit' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-600 hover:bg-red-200'}">
                                <i class="fas fa-times mr-1"></i>Sakit
                            </button>
                        </div>
                        
                        ${attendance.timeIn ? `
                            <div class="mt-3 text-xs text-gray-600">
                                <div><i class="fas fa-sign-in-alt mr-1"></i>Masuk: ${attendance.timeIn}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function setAttendance(npm, status) {
            const today = new Date().toDateString();
            const studentKey = `${npm}_${today}`;
            const currentTime = new Date().toLocaleTimeString('id-ID');
            
            if (!attendanceData[studentKey]) {
                attendanceData[studentKey] = { status: '', timeIn: '', timeOut: '' };
            }
            
            attendanceData[studentKey].status = status;
            
            // Set waktu masuk jika status hadir
            if (status === 'hadir') {
                attendanceData[studentKey].timeIn = currentTime;
            }
            
            // Update monthly data
            updateMonthlyData(npm, status);
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('monthlyData', JSON.stringify(monthlyData));
            
            renderStudentGrid();
            updateRecapStats();
        }

        function updateMonthlyData(npm, status) {
            const now = new Date();
            const monthKey = `${now.getFullYear()}_${now.getMonth()}`;
            
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = {};
            }
            
            if (!monthlyData[monthKey][npm]) {
                monthlyData[monthKey][npm] = { hadir: 0, izin: 0, sakit: 0 };
            }
            
            // Reset previous status for today
            const today = new Date().toDateString();
            const prevStatus = attendanceData[`${npm}_${today}`]?.status;
            if (prevStatus && prevStatus !== status) {
                monthlyData[monthKey][npm][prevStatus] = Math.max(0, monthlyData[monthKey][npm][prevStatus] - 1);
            }
            
            monthlyData[monthKey][npm][status]++;
        }

        function setupEventListeners() {
            document.getElementById('absenMasuk').addEventListener('click', () => {
                currentAttendanceType = 'masuk';
                document.getElementById('absenMasuk').classList.add('ring-4', 'ring-green-300');
            });

            document.getElementById('hadirSemua').addEventListener('click', () => {
                students.forEach(student => {
                    setAttendance(student.npm, 'hadir');
                });
            });

            document.getElementById('viewRecap').addEventListener('click', () => {
                document.getElementById('mainPage').classList.add('hidden');
                document.getElementById('recapPage').classList.remove('hidden');
                renderDailyRecap();
                renderMonthlyRecap();
            });

            document.getElementById('backToMain').addEventListener('click', () => {
                document.getElementById('recapPage').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
            });

            document.getElementById('dailyTab').addEventListener('click', () => {
                document.getElementById('dailyRecap').classList.remove('hidden');
                document.getElementById('monthlyRecap').classList.add('hidden');
                document.getElementById('dailyTab').classList.add('bg-blue-500', 'text-white');
                document.getElementById('dailyTab').classList.remove('text-gray-600');
                document.getElementById('monthlyTab').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('monthlyTab').classList.add('text-gray-600');
            });

            document.getElementById('monthlyTab').addEventListener('click', () => {
                document.getElementById('monthlyRecap').classList.remove('hidden');
                document.getElementById('dailyRecap').classList.add('hidden');
                document.getElementById('monthlyTab').classList.add('bg-blue-500', 'text-white');
                document.getElementById('monthlyTab').classList.remove('text-gray-600');
                document.getElementById('dailyTab').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('dailyTab').classList.add('text-gray-600');
            });

            document.getElementById('printRecap').addEventListener('click', () => {
                window.print();
            });

            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);

            document.getElementById('monthSelect').addEventListener('change', renderMonthlyRecap);
        }

        function updateRecapStats() {
            const today = new Date().toDateString();
            let hadir = 0, izin = 0, sakit = 0;
            
            students.forEach(student => {
                const studentKey = `${student.npm}_${today}`;
                const attendance = attendanceData[studentKey];
                if (attendance) {
                    if (attendance.status === 'hadir') hadir++;
                    else if (attendance.status === 'izin') izin++;
                    else if (attendance.status === 'sakit') sakit++;
                }
            });
            
            document.getElementById('totalHadir').textContent = hadir;
            document.getElementById('totalIzin').textContent = izin;
            document.getElementById('totalSakit').textContent = sakit;
        }

        function renderDailyRecap() {
            const today = new Date().toDateString();
            const tbody = document.getElementById('dailyTableBody');
            
            tbody.innerHTML = students.map((student, index) => {
                const studentKey = `${student.npm}_${today}`;
                const attendance = attendanceData[studentKey] || { status: '-', timeIn: '-', timeOut: '-' };
                
                let statusBadge = '';
                if (attendance.status === 'hadir') {
                    statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Hadir</span>';
                } else if (attendance.status === 'izin') {
                    statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">Izin</span>';
                } else if (attendance.status === 'sakit') {
                    statusBadge = '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">Sakit</span>';
                } else {
                    statusBadge = '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">-</span>';
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-3 font-medium">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-3">${student.npm}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${statusBadge}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${attendance.timeIn || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderMonthlyRecap() {
            const selectedMonth = parseInt(document.getElementById('monthSelect').value);
            const currentYear = new Date().getFullYear();
            const monthKey = `${currentYear}_${selectedMonth}`;
            const tbody = document.getElementById('monthlyTableBody');
            
            tbody.innerHTML = students.map((student, index) => {
                const monthlyStats = monthlyData[monthKey]?.[student.npm] || { hadir: 0, izin: 0, sakit: 0 };
                const total = monthlyStats.hadir + monthlyStats.izin + monthlyStats.sakit;
                const percentage = total > 0 ? Math.round((monthlyStats.hadir / total) * 100) : 0;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-3 font-medium">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-3">${student.npm}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${monthlyStats.hadir}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${monthlyStats.izin}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${monthlyStats.sakit}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            <span class="font-semibold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">${percentage}%</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function exportToPDF() {
            // Debug: Check if libraries are loaded
            console.log('jsPDF available:', !!window.jspdf);
            console.log('autoTable available:', !!window.jspdf?.jsPDF?.prototype?.autoTable);
            
            // Wait for libraries to load if needed
            setTimeout(() => {
                try {
                    // Try different ways to access jsPDF
                    let jsPDF;
                    if (window.jspdf && window.jspdf.jsPDF) {
                        jsPDF = window.jspdf.jsPDF;
                    } else if (window.jsPDF) {
                        jsPDF = window.jsPDF;
                    } else {
                        alert('Library PDF belum dimuat. Silakan tunggu sebentar dan coba lagi.');
                        return;
                    }
                    
                    const doc = new jsPDF();
                    
                    // Header dengan positioning yang lebih sederhana
                    doc.setFontSize(16);
                    doc.text('UNIVERSITAS GUNADARMA', 105, 20, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text('FAKULTAS SISTEM INFORMASI', 105, 30, { align: 'center' });
                    doc.text('PROGRAM STUDI S1', 105, 40, { align: 'center' });
                    doc.text('KELAS 1KA21-SISTEM INFORMASI', 105, 50, { align: 'center' });
                    
                    const isDailyActive = !document.getElementById('dailyRecap').classList.contains('hidden');
                    
                    if (isDailyActive) {
                        // Daily Report
                        doc.setFontSize(12);
                        doc.text(`Rekap Kehadiran Harian - ${new Date().toLocaleDateString('id-ID')}`, 105, 65, { align: 'center' });
                        
                        const today = new Date().toDateString();
                        const tableData = students.map((student, index) => {
                            const studentKey = `${student.npm}_${today}`;
                            const attendance = attendanceData[studentKey] || { status: '-', timeIn: '-' };
                            return [
                                index + 1,
                                student.name,
                                student.npm,
                                attendance.status === 'hadir' ? 'Hadir' : 
                                attendance.status === 'izin' ? 'Izin' : 
                                attendance.status === 'sakit' ? 'Sakit' : '-',
                                attendance.timeIn || '-'
                            ];
                        });
                        
                        // Check if autoTable is available
                        if (doc.autoTable) {
                            doc.autoTable({
                                head: [['No', 'Nama', 'NPM', 'Status', 'Waktu Masuk']],
                                body: tableData,
                                startY: 75,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [59, 130, 246] }
                            });
                        } else {
                            // Fallback: simple table without autoTable
                            let yPos = 80;
                            doc.setFontSize(10);
                            doc.text('No  Nama                           NPM        Status    Waktu', 20, yPos);
                            yPos += 10;
                            
                            tableData.forEach(row => {
                                const text = `${row[0]}   ${row[1].substring(0,25)}   ${row[2]}   ${row[3]}   ${row[4]}`;
                                doc.text(text, 20, yPos);
                                yPos += 6;
                                if (yPos > 280) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                            });
                        }
                    } else {
                        // Monthly Report
                        const selectedMonth = parseInt(document.getElementById('monthSelect').value);
                        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                         'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                        
                        doc.setFontSize(12);
                        doc.text(`Rekap Kehadiran Bulanan - ${monthNames[selectedMonth]} ${new Date().getFullYear()}`, 105, 65, { align: 'center' });
                        
                        const currentYear = new Date().getFullYear();
                        const monthKey = `${currentYear}_${selectedMonth}`;
                        
                        const tableData = students.map((student, index) => {
                            const monthlyStats = monthlyData[monthKey]?.[student.npm] || { hadir: 0, izin: 0, sakit: 0 };
                            const total = monthlyStats.hadir + monthlyStats.izin + monthlyStats.sakit;
                            const percentage = total > 0 ? Math.round((monthlyStats.hadir / total) * 100) : 0;
                            
                            return [
                                index + 1,
                                student.name,
                                student.npm,
                                monthlyStats.hadir,
                                monthlyStats.izin,
                                monthlyStats.sakit,
                                `${percentage}%`
                            ];
                        });
                        
                        if (doc.autoTable) {
                            doc.autoTable({
                                head: [['No', 'Nama', 'NPM', 'Hadir', 'Izin', 'Sakit', 'Persentase']],
                                body: tableData,
                                startY: 75,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [59, 130, 246] }
                            });
                        } else {
                            // Fallback: simple table
                            let yPos = 80;
                            doc.setFontSize(10);
                            doc.text('No  Nama                     NPM        H  I  S  %', 20, yPos);
                            yPos += 10;
                            
                            tableData.forEach(row => {
                                const text = `${row[0]}   ${row[1].substring(0,20)}   ${row[2]}   ${row[3]}  ${row[4]}  ${row[5]}  ${row[6]}`;
                                doc.text(text, 20, yPos);
                                yPos += 6;
                                if (yPos > 280) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                            });
                        }
                    }
                    
                    const fileName = isDailyActive ? 
                        `Rekap_Harian_${new Date().toISOString().split('T')[0]}.pdf` :
                        `Rekap_Bulanan_${new Date().getFullYear()}_${document.getElementById('monthSelect').selectedOptions[0].text}.pdf`;
                    
                    doc.save(fileName);
                    
                } catch (error) {
                    console.error('Error exporting PDF:', error);
                    alert(`Terjadi kesalahan saat mengexport PDF: ${error.message}`);
                }
            }, 500); // Wait 500ms for libraries to load
        }

        function exportToExcel() {
            // Debug: Check if XLSX library is loaded
            console.log('XLSX available:', !!window.XLSX);
            
            // Wait for library to load if needed
            setTimeout(() => {
                try {
                    if (!window.XLSX) {
                        alert('Library Excel belum dimuat. Silakan tunggu sebentar dan coba lagi.');
                        return;
                    }
                    
                    const isDailyActive = !document.getElementById('dailyRecap').classList.contains('hidden');
                    let data = [];
                    let fileName = '';
                    
                    if (isDailyActive) {
                        // Daily Report
                        const today = new Date().toDateString();
                        data = [
                            ['UNIVERSITAS GUNADARMA'],
                            ['FAKULTAS SISTEM INFORMASI'],
                            ['PROGRAM STUDI S1'],
                            ['KELAS 1KA21-SISTEM INFORMASI'],
                            [''],
                            [`Rekap Kehadiran Harian - ${new Date().toLocaleDateString('id-ID')}`],
                            [''],
                            ['No', 'Nama', 'NPM', 'Status', 'Waktu Masuk']
                        ];
                        
                        students.forEach((student, index) => {
                            const studentKey = `${student.npm}_${today}`;
                            const attendance = attendanceData[studentKey] || { status: '-', timeIn: '-' };
                            data.push([
                                index + 1,
                                student.name,
                                student.npm,
                                attendance.status === 'hadir' ? 'Hadir' : 
                                attendance.status === 'izin' ? 'Izin' : 
                                attendance.status === 'sakit' ? 'Sakit' : '-',
                                attendance.timeIn || '-'
                            ]);
                        });
                        
                        fileName = `Rekap_Harian_${new Date().toISOString().split('T')[0]}.xlsx`;
                    } else {
                        // Monthly Report
                        const selectedMonth = parseInt(document.getElementById('monthSelect').value);
                        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                         'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                        const currentYear = new Date().getFullYear();
                        const monthKey = `${currentYear}_${selectedMonth}`;
                        
                        data = [
                            ['UNIVERSITAS GUNADARMA'],
                            ['FAKULTAS SISTEM INFORMASI'],
                            ['PROGRAM STUDI S1'],
                            ['KELAS 1KA21-SISTEM INFORMASI'],
                            [''],
                            [`Rekap Kehadiran Bulanan - ${monthNames[selectedMonth]} ${currentYear}`],
                            [''],
                            ['No', 'Nama', 'NPM', 'Hadir', 'Izin', 'Sakit', 'Persentase']
                        ];
                        
                        students.forEach((student, index) => {
                            const monthlyStats = monthlyData[monthKey]?.[student.npm] || { hadir: 0, izin: 0, sakit: 0 };
                            const total = monthlyStats.hadir + monthlyStats.izin + monthlyStats.sakit;
                            const percentage = total > 0 ? Math.round((monthlyStats.hadir / total) * 100) : 0;
                            
                            data.push([
                                index + 1,
                                student.name,
                                student.npm,
                                monthlyStats.hadir,
                                monthlyStats.izin,
                                monthlyStats.sakit,
                                `${percentage}%`
                            ]);
                        });
                        
                        fileName = `Rekap_Bulanan_${currentYear}_${monthNames[selectedMonth]}.xlsx`;
                    }
                    
                    // Create worksheet with error handling
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    
                    // Try to set column widths (optional feature)
                    try {
                        const colWidths = isDailyActive ? 
                            [{ wch: 5 }, { wch: 35 }, { wch: 15 }, { wch: 10 }, { wch: 15 }] :
                            [{ wch: 5 }, { wch: 35 }, { wch: 15 }, { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 12 }];
                        
                        ws['!cols'] = colWidths;
                    } catch (e) {
                        console.log('Column width setting failed, continuing without it');
                    }
                    
                    // Create workbook and save
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                    
                    // Try to save file
                    XLSX.writeFile(wb, fileName);
                    
                    console.log('Excel export successful:', fileName);
                    
                } catch (error) {
                    console.error('Error exporting Excel:', error);
                    alert(`Terjadi kesalahan saat mengexport Excel: ${error.message}`);
                    
                    // Fallback: create CSV instead
                    try {
                        exportToCSV();
                    } catch (csvError) {
                        console.error('CSV fallback also failed:', csvError);
                    }
                }
            }, 500); // Wait 500ms for library to load
        }
        
        // Fallback CSV export function
        function exportToCSV() {
            const isDailyActive = !document.getElementById('dailyRecap').classList.contains('hidden');
            let csvContent = '';
            
            if (isDailyActive) {
                csvContent = 'No,Nama,NPM,Status,Waktu Masuk\n';
                const today = new Date().toDateString();
                
                students.forEach((student, index) => {
                    const studentKey = `${student.npm}_${today}`;
                    const attendance = attendanceData[studentKey] || { status: '-', timeIn: '-' };
                    const status = attendance.status === 'hadir' ? 'Hadir' : 
                                 attendance.status === 'izin' ? 'Izin' : 
                                 attendance.status === 'sakit' ? 'Sakit' : '-';
                    
                    csvContent += `${index + 1},"${student.name}",${student.npm},${status},${attendance.timeIn || '-'}\n`;
                });
            } else {
                csvContent = 'No,Nama,NPM,Hadir,Izin,Sakit,Persentase\n';
                const selectedMonth = parseInt(document.getElementById('monthSelect').value);
                const currentYear = new Date().getFullYear();
                const monthKey = `${currentYear}_${selectedMonth}`;
                
                students.forEach((student, index) => {
                    const monthlyStats = monthlyData[monthKey]?.[student.npm] || { hadir: 0, izin: 0, sakit: 0 };
                    const total = monthlyStats.hadir + monthlyStats.izin + monthlyStats.sakit;
                    const percentage = total > 0 ? Math.round((monthlyStats.hadir / total) * 100) : 0;
                    
                    csvContent += `${index + 1},"${student.name}",${student.npm},${monthlyStats.hadir},${monthlyStats.izin},${monthlyStats.sakit},${percentage}%\n`;
                });
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', isDailyActive ? 
                `Rekap_Harian_${new Date().toISOString().split('T')[0]}.csv` :
                `Rekap_Bulanan_${new Date().getFullYear()}_${document.getElementById('monthSelect').selectedOptions[0].text}.csv`
            );
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('File berhasil diunduh dalam format CSV (karena Excel library bermasalah)');
        }

        // Set current month in select
        document.getElementById('monthSelect').value = new Date().getMonth();
        
        // Initialize with absen masuk selected
        document.getElementById('absenMasuk').classList.add('ring-4', 'ring-green-300');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9622aa579296ce86',t:'MTc1MzAxNjY3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
